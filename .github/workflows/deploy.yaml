name: Pipeline CI/CD

on:
  push:
    branches:
      - main

#temos que configurar o permissions após aplicar a politica
permissions:
  id-token: write
  contents: read
jobs:
  job1:
    name: build_ecr
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5.0.0
      - name: "Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4.3.1

        # aqui estamos aplicando as permissões
        with:
          role-to-assume: arn:aws:iam::656580157831:role/GitHUbActionsRepoApp
          aws-region: us-east-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2

        # github actions marketplace
      - name: Amazon ECR "Login" Action for github actions
        uses: aws-actions/amazon-ecr-login@v2.0.1

      - name: Build Image, Tag, and Push image to Amazon ECR
        run:  | 
          docker build -t meu-website:v1.0 .
          docker tag meu-website:v1.0 656580157831.dkr.ecr.us-east-2.amazonaws.com/site_prod:v1.0
          docker push 656580157831.dkr.ecr.us-east-2.amazonaws.com/site_prod:v1.0

  job2:
    needs: job1
    name: deploy_ec2
    env: 
      INSTANCE_KEY: ${{secrets.INSTANCE_KEY}}
      PUBLIC_IP: ${{secrets.PUBLIC_IP}}

    runs-on: ubuntu-latest
    steps: 
      - name: Deploy EC2 SSH
        run: |
          echo "$INSTANCE_KEY" > chave-site-prod.pem
          chmod 400 chave-site-prod.pem
          ssh -i chave-site-prod.pem -o StrictHostKeyChecking=no ec2-user@$PUBLIC_IP << EOF
            aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 656580157831.dkr.ecr.us-east-2.amazonaws.com
            docker pull 656580157831.dkr.ecr.us-east-2.amazonaws.com:v1.0
            echo "parando container antigo site"
            docker stop site || true
            echo "removendo o container antigo"
            docker rm site ||  true
            echo "rodando nova tag da imagem"
            docker run -d -p 80:80 --name site 656580157831.dkr.ecr.us-east-2.amazonaws.com:v1.0
            echo "parabens! imagem atualizad"
            docker ps

            echo"finish"
          EOF

          rm chave-site-prod.pem





